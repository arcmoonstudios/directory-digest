name: Publish VSIX

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read

jobs:
  build:
    name: Build & Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.24.0'
      - name: Install catalog dependencies
        run: pnpm install
      - name: Build the extension
        run: pnpm run vscode:prepublish
      - name: Generate VSIX via packaging helper
        run: pnpm run package:vsix
      - name: Upload created VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix
          path: DirectoryDigest-*.vsix

  publish:
    name: Publish to Marketplace
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.24.0'
      - name: Download VSIX
        uses: actions/download-artifact@v4
        with:
          name: vsix
      - name: Validate VSCE_PAT secret
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          if [ -z "$VSCE_PAT" ]; then
            echo "Missing VSCE_PAT secret. Add it to repository secrets as VSCE_PAT. Aborting."
            exit 2
          fi
      - name: Publish VSIX with vsce
        # Put the secret here at the step-level to avoid job-level 'context access might be invalid' warnings
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          pnpm install -g @vscode/vsce
          # find the artifact file and publish via vsce using token in env
          VSIX_FILE=$(ls DirectoryDigest-*.vsix | head -n 1 || true)
          if [ -z "$VSIX_FILE" ]; then
            echo "VSIX file not found"
            exit 2
          fi
          pnpm exec vsce publish -p "$VSCE_PAT" --packagePath "$VSIX_FILE"
